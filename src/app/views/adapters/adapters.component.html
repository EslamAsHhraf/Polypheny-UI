<ng-container [ngSwitch]="route">

    <!-- availableAdapters -->
    <c-row *ngSwitchCase="['addStore','addSource'].includes(route) ? route : ''">
        <c-col>
            <h2>Adapters</h2>
        </c-col>
    </c-row>
    <c-row class="row" *ngSwitchCase="['addStore','addSource'].includes(route) ? route : ''">
        <button cButton color="primary" class="btn-circle topRight" [routerLink]="['./../']">
            <i class="fa fa-close"></i>
        </button>

        <c-col *ngIf="getAvailableAdapters()">
            <table cTable size="sm" hover bordered striped id="adapter-table">
                <thead>
                <tr>
                    <th>Logo</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Deploy</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let adapter of getAvailableAdapters()">
                    <td class="center">
                        <ng-container *ngIf="getLogo(adapter.name).startsWith('assets/')">
                            <img [src]="getLogo(adapter.name)" alt="">
                        </ng-container>
                        <ng-container *ngIf="!getLogo(adapter.name).startsWith('assets/')">
                            <i [class]="getLogo(adapter.name)"></i>
                        </ng-container>
                    </td>
                    <td><strong>{{adapter.name}}</strong></td>
                    <td>{{adapter.description}}</td>
                    <td class="center">
                        <button cButton size="sm" color="primary" (click)="initDeployModal(adapter)">Deploy</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </c-col>
    </c-row>

    <!-- template for current stores and sources, it is called below -->
    <ng-template #adapterTemplate let-adapters="adapters" let-type="type">
        <c-col lg="6" class="col-lg-6 fixed-width" *ngFor="let adapter of adapters">

            <c-card class="fixed-height">
                <c-card-header class="card-header-adapter">
                    <p>{{adapter.name}}</p>
                    <span *ngIf="adapter.settings['mode'] === 'docker'" class="badge badge-primary">Docker</span>
                    <span *ngIf="adapter.settings['mode'] === 'remote'" class="badge badge-primary bg-green">Remote</span>
                    <span *ngIf="adapter.settings['mode'] === 'embedded'"
                          class="badge badge-dark">Embedded</span>
                </c-card-header>
                <c-card-body>
                    <img *ngIf="getLogo(adapter.adapterName).startsWith('assets/')" [src]="getLogo(adapter.adapterName)"
                         alt="" class="logo">
                    <i *ngIf="!getLogo(adapter.adapterName).startsWith('assets/')"
                       [class]="'logo ' + getLogo(adapter.adapterName)"></i>
                    <span class="mb-2">Adapter: {{adapter.adapterName}}</span>

                    <span *ngIf="adapter.dataReadOnly"><span class="fa fa-eye"></span> read-only</span>
                    <span *ngIf="adapter.persistent"><span class="fa fa-floppy-o" style="padding-left: 1px"></span> persistent</span>
                    <span *ngIf="adapter.settings.hasOwnProperty('host') && adapter.settings.hasOwnProperty('port')">{{adapter.settings['host']}}
                        <span *ngIf="adapter.settings['mode'] === 'remote'">: {{adapter.settings['port']}}</span>
                    </span>
                </c-card-body>
                <c-card-footer class="bg-transparent">
                    <button cButton color="danger" (click)="removeAdapter(adapter)"
                            (mouseleave)="resetDeletingAdapter(adapter)" [ngClass]="{'disabled': isDeleting(adapter)}">
                        <i class="text-white" *ngIf="!isDeleting(adapter)"
                           [ngClass]="{'cil-trash': adapter !== deletingAdapter, 'cil-warning': adapter === deletingAdapter}"></i>
                        <c-spinner *ngIf="isDeleting(adapter)" size="sm" cBorder color="light" role="status"></c-spinner>
                    </button>
                    <button cButton color="primary" class="pull-right" (click)="initAdapterSettingsModal(adapter)">
                        Configure
                    </button>
                </c-card-footer>
            </c-card>

        </c-col>
        <c-col size="6" class="col-lg-6 fixed-height add-adapter-wrapper">
            <button cButton color="primary" *ngIf="type === 'source'" class="add-adapter" [routerLink]="['./addSource']">
                <i class="fa fa-plus"></i>
            </button>
            <button cButton color="primary" *ngIf="type === 'store'" class="add-adapter" [routerLink]="['./addStore']">
                <i class="fa fa-plus"></i>
            </button>
        </c-col>
    </ng-template>

    <!-- show current stores and sources -->
    <div *ngSwitchDefault>
        <c-row>
            <c-col size="12">
                <h2>Stores</h2>
            </c-col>
        </c-row>
        <c-row class="adapters">
            <ng-container *ngTemplateOutlet="adapterTemplate; context:{adapters: (stores|async), type: 'store'}"></ng-container>
        </c-row>
    </div>
    <div *ngSwitchDefault>
        <c-row>
            <c-col size="12">
                <h2>Sources</h2>
            </c-col>
        </c-row>
        <c-row class="adapters">
            <ng-container
                    *ngTemplateOutlet="adapterTemplate; context:{adapters: (sources|async), type: 'source'}"></ng-container>
        </c-row>
    </div>

</ng-container>


<c-modal class="modal fade" role="dialog"
         [visible]="modalActive"
         aria-labelledby="myModalLabel" aria-hidden="true" id="editUserModal" (visibleChange)="onCloseModal()">

    <c-modal-content>
        <c-modal-header>
            <h4 cModalTitle>{{activeMode ? "Settings" : "Deployment Mode"}}</h4>
            <button (click)="modalActive = false" cButtonClose></button>
        </c-modal-header>

        <!-- Edit adapter settings -->
        <c-modal-body *ngIf="editingAdapter && editingAdapter.settings">
            <form [formGroup]="editingAdapterForm" autocomplete="off" (ngSubmit)="saveAdapterSettings()">
                <div class="form-group" *ngFor="let control of editingAdapterForm.controls | keyvalue">
                    <div>
                        <c-input-group
                                *ngIf="!getAdapterSetting(editingAdapter, control.key).options && !getAdapterSetting(editingAdapter, control.key).fileNames">
                            <span cInputGroupText cTooltipPlacement="left" [cTooltip]="getAdapterSetting(editingAdapter, control.key).description">{{control.key}}</span>
                            <input cFormControl type="text" [id]="control.key"
                                   [formControlName]="control.key"
                                   [ngClass]="validate(editingAdapterForm, control.key)">
                            <c-form-feedback>required</c-form-feedback>
                        </c-input-group>
                        <div class="form-group" *ngIf="getAdapterSetting(editingAdapter, control.key).options">
                            <c-input-group class="select-wrapper" *ngIf="!getAdapterSetting(editingAdapter, control.key).dynamic; else editDynamic">
                                        <span cInputGroupText cTooltipPlacement="left" [cTooltip]="getAdapterSetting(editingAdapter, control.key).description">
                                            {{control.key}}
                                        </span>
                                <select cSelect [id]="control.key" [formControlName]="control.key">
                                    <option *ngFor="let option of getAdapterSetting(editingAdapter, control.key).options"
                                            [value]="option">
                                        {{option}}
                                    </option>
                                </select>
                            </c-input-group>
                            <!--dynamic select, which use ids internally-->
                            <ng-template #editDynamic>
                                <c-input-group class="select-wrapper">
                                    <span cInputGroupText cTooltipPlacement="left" [cTooltip]="getAdapterSetting(editingAdapter, control.key).description"></span>
                                    <select cSelect [id]="control.key" [formControlName]="control.key">
                                        <option *ngFor="let option of getAdapterSetting(editingAdapter, control.key).options"
                                                [value]="option">{{getAdapterSetting( editingAdapter, control.key ).alias[option]}}</option>
                                    </select>
                                </c-input-group>
                            </ng-template>
                        </div>
                        <c-input-group *ngIf="getAdapterSetting(editingAdapter, control.key).fileNames">
                            <span cInputGroupText cTooltipPlacement="left" [cTooltip]="getAdapterSetting(editingAdapter, control.key).description">{{control.key}}</span>
                            <span cFormText *ngIf="!getAdapterSetting(editingAdapter, control.key).modifiable" type="text" disabled></span>
                            <span cFormText *ngIf="getAdapterSetting(editingAdapter, control.key).modifiable" style="position: relative; text-align: left; white-space: nowrap; overflow: hidden">
                                    {{fileLabel}}
                                </span>
                            <input cFormControl type="file" multiple style="display: none" [id]="control.key"
                                   [ngClass]="validate(editingAdapterForm, control.key)"
                                   (change)="onFileChange($event, editingAdapterForm, control.key)">
                            <c-form-feedback>required</c-form-feedback>
                        </c-input-group>
                    </div>
                </div>
            </form>
        </c-modal-body>

        <!-- Form for deploying -->
        <c-modal-body *ngIf="editingAvailableAdapter && editingAvailableAdapter.adapterSettings">
            <div *ngIf="!activeMode; else options">
                <div>
                    <button cButton size="lg" color="primary" *ngFor="let mode of modeSettings" class="me-1 btn-block"
                            (click)="setMode(mode)">{{mode}}</button>
                </div>
            </div>

            <ng-template #options>
                <div *ngIf="!handshaking; else secure">
                    <form [formGroup]="availableAdapterUniqueNameForm" (ngSubmit)="deploy()" autocomplete="off">
                        <div class="form-group">
                            <c-input-group>
                                <span cFormText>Unique Name</span>
                                <input cFormControl type="text" id="adapterUniqueName"
                                       formControlName="uniqueName"
                                       [ngClass]="validate(availableAdapterUniqueNameForm, 'uniqueName')">
                                <c-form-feedback>{{getFeedback()}}</c-form-feedback>
                            </c-input-group>
                        </div>
                    </form>
                    <form [formGroup]="editingAvailableAdapterForm" (ngSubmit)="deploy()" autocomplete="off">
                        <div class="form-group"
                             *ngFor="let control of editingAvailableAdapterForm.controls  | keyvalue: positionOrder( editingAvailableAdapter)">
                            <div *ngIf=" !getAdapterSetting(editingAvailableAdapter, control.key).subOf || subIsActive(editingAvailableAdapter, getAdapterSetting(editingAvailableAdapter, control.key).subOf)">
                                <c-input-group *ngIf="!getAdapterSetting(editingAvailableAdapter, control.key).options && !getAdapterSetting(editingAvailableAdapter, control.key).fileNames">
                                    <span cFormText [cTooltip]="getAdapterSetting(editingAvailableAdapter, control.key).description" cTooltipPlacement="left" class="input-group-text">{{control.key}}</span>
                                    <input cFormControl type="text" [id]="control.key"
                                           [formControlName]="control.key"
                                           [ngClass]="validate(control.value, control.key)">
                                    <c-form-feedback>{{ getGenericFeedback( control.key )}}</c-form-feedback>
                                </c-input-group>
                                <div class="form-group"
                                     *ngIf="getAdapterSetting(editingAvailableAdapter, control.key).options">
                                    <c-input-group class="select-wrapper"
                                                   *ngIf="!getAdapterSetting(editingAvailableAdapter, control.key).dynamic; else dynamicSelect">
                                            <span cFormText [cTooltip]="getAdapterSetting(editingAvailableAdapter, control.key).description" class="input-group-text" tooltip]="getAdapterSetting(editingAvailableAdapter, control.key).description"
                                                  cTooltipPlacement="left">
                                                {{control.key}}
                                            </span>

                                        <select cSelect [id]="control.key"
                                                [ngClass]="validate(control.value, control.key)"
                                                [formControlName]="control.key"
                                                (change)="onChange(control.key, control.value)">
                                            <option *ngFor="let option of getAdapterSetting(editingAvailableAdapter, control.key).options"
                                                    [value]="option">{{option}}</option>
                                        </select>
                                        <c-form-feedback>{{ getGenericFeedback( control.key )}}</c-form-feedback>
                                    </c-input-group>
                                    <ng-template #dynamicSelect>
                                        <c-input-group class="select-wrapper select-dynamic">
                                            <label cInputGroupText [cTooltip]="getAdapterSetting(editingAvailableAdapter, control.key).description" cTooltipPlacement="left"
                                                   [for]="control.key">{{getAdapterSetting( editingAvailableAdapter, control.key ).nameAlias}}</label>

                                            <select cSelect [id]="control.key"
                                                    [ngClass]="validate(control.value, control.key)"
                                                    [formControlName]="control.key">
                                                <option *ngFor="let option of getAdapterSetting(editingAvailableAdapter, control.key).options"
                                                        [value]="option">{{getAdapterSetting( editingAvailableAdapter, control.key ).alias[option]}}</option>
                                            </select>
                                            <c-form-feedback>{{ getGenericFeedback( control.key )}}</c-form-feedback>
                                        </c-input-group>
                                    </ng-template>
                                </div>
                                <c-input-group
                                        *ngIf="getAdapterSetting(editingAvailableAdapter, control.key).fileNames">
                                    <span cInputGroupText cTooltipPlacement="left" [cTooltip]="getAdapterSetting(editingAvailableAdapter, control.key).description">{{control.key}}</span>
                                    <span cFormText style="position: relative; text-align: left; white-space: nowrap; overflow: hidden"></span>
                                    <input type="file" multiple style="display: none" [id]="control.key"
                                           [ngClass]="validate(control.value, control.key)"
                                           (change)="onFileChange($event, editingAvailableAdapterForm, control.key)">
                                    {{fileLabel}}

                                    <c-form-feedback>{{ getGenericFeedback( control.key )}}</c-form-feedback>
                                </c-input-group>
                            </div>
                        </div>
                    </form>
                </div>
            </ng-template>

            <ng-template #secure>
                <p>Due to the limited permissions available to browsers, Polypheny cannot directly link files via
                    UI.</p>
                <p>As a security measure, the established link has to be validated by the backend, for this it
                    requires a <i><strong>polypheny.access</strong></i>, with the following content in the target
                    directory:</p>
                <p><i><strong>{{this.accessId}}</strong></i></p>
                <p>This can be done created manually or downloaded: <a class="btn btn-primary" (click)="createSecureFile()" download>
                    <i class="cui-file"></i>
                </a>
                </p>


            </ng-template>
        </c-modal-body>

        <c-modal-footer>
            <button cButton color="secondary" (click)="modalActive = true">Close</button>
            <button cButton color="primary" *ngIf="editingAdapter" type="submit" (click)="saveAdapterSettings()"
                    [disabled]="!editingAdapterForm.valid">Save
            </button>
            <button cButton color="primary" *ngIf="editingAvailableAdapter && activeMode && !handshaking" type="submit"
                    (click)="deploy()"
                    [disabled]="!availableAdapterUniqueNameForm.valid || !editingAvailableAdapterForm.valid || deploying || handshaking">
                <span *ngIf="!deploying && !handshaking">Deploy</span>
                <c-spinner size="sm" *ngIf="deploying || handshaking" role="status">
                        <span class="sr-only">{{ handshaking ? 'Security checking...' : 'Loading...' }}</span>
                </c-spinner>
            </button>
            <button cButton color="primary" *ngIf="handshaking" (click)="continueSecureDeploy()">Continue</button>
        </c-modal-footer>
    </c-modal-content><!-- /.modal-content -->
</c-modal>
